AWSTemplateFormatVersion: 2010-09-09
Description: Creates DevOps / jump box
Parameters:
  S3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription: >-
      Bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: aws-quickstart
    Description: >-
      S3 bucket name for the Quick Start assets. Quick Start bucket name can
      include numbers, lowercase letters, uppercase letters, and hyphens (-). It
      cannot start or end with a hyphen (-).
    Type: String
  PublicSubnet1ID:
    Description: Public Subnet Id 1
    Type: 'AWS::EC2::Subnet::Id'
  KeyPairName:
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: Name of an existing EC2 KeyPair.
  SecGroup:
    Description: "Security Group ID."
    Type: 'List<AWS::EC2::SecurityGroup::Id>'
  InstanceType:
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
    ConstraintDescription: "must be a valid EC2 instance type."
    Default: t3.medium
    Description: "EC2 instance type"
    Type: String
  VolumeSize:
    Type: Number
    Description: "EBS volume size of the DevOps Instance in GB"
    Default: 16
Mappings:
  AWSAMIRegionMapDevOps:
    AMI:
      US1604HVM: ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-*
    eu-north-1:
      US1604HVM: ami-004baf4bebfc60e00
    ap-south-1:
      US1604HVM: ami-050d142d4db023b60
    eu-west-3:
      US1604HVM: ami-05dbde73d870dde1d
    eu-west-2:
      US1604HVM: ami-0a614b729ef585e96
    eu-west-1:
      US1604HVM: ami-04533969992547875
    ap-northeast-2:
      US1604HVM: ami-0761dd1f89936259e
    ap-northeast-1:
      US1604HVM: ami-058c6e5b73b074cd2
    sa-east-1:
      US1604HVM: ami-0b105ed6ad5255125
    ca-central-1:
      US1604HVM: ami-09a79257f435d556a
    ap-southeast-1:
      US1604HVM: ami-0bd999ddca2c8ba67
    ap-southeast-2:
      US1604HVM: ami-0a81041a48bbbbd69
    eu-central-1:
      US1604HVM: ami-074a2642e2a3737d2
    us-east-1:
      US1604HVM: ami-0edfed9d6e9a4031b
    us-east-2:
      US1604HVM: ami-0735e22e032b35e38
    us-west-1:
      US1604HVM: ami-0b91a410940e82c54
    us-west-2:
      US1604HVM: ami-00a0cf500e59c9f7c
Resources:
  InstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          -
            Effect: 'Allow'
            Principal:
              Service:
                - 'ec2.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      Path: '/'
  InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: '/'
      Roles:
        - Ref: 'InstanceRole'
  AuthenticatedS3Policy:
    Type: AWS::IAM::Policy
    Properties:
        PolicyName: AuthenticatedS3GetObjects
        Roles:
        - !Ref InstanceRole
        PolicyDocument:
          Statement:
            - Sid: BucketAccess
              Effect: Allow
              Action:
                - 's3:GetObject'
              Resource: !Sub arn:aws:s3:::${S3BucketName}/*
  DevNode1:
    Type: 'AWS::EC2::Instance'
    Metadata:
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          roleName: !Ref InstanceRole
          buckets: !Ref S3BucketName
    Properties:
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref InstanceProfile
      NetworkInterfaces:
        - DeleteOnTermination: true
          DeviceIndex: '0'
          SubnetId: !Ref PublicSubnet1ID
          GroupSet: !Ref SecGroup
      KeyName: !Ref KeyPairName
      ImageId: !FindInMap
        - AWSAMIRegionMapDevOps
        - !Ref 'AWS::Region'
        - US1604HVM
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: !Ref VolumeSize
            VolumeType: gp2
      Tags:
          - Key: Name
            Value: DevOps
Outputs:
  DevIpAddress:
    Value: !GetAtt DevNode1.PublicIp
    Description: Dev Jump box Public IP
  DevUrl:
    Value: "http://oss-getting-started.s3-website-us-east-1.amazonaws.com"
    Description: Dev Url
